Quiero instalar Home Assistant, NodeRed, influxdb y grafana en contenedores docker dentro de una maquina debian 12, para aconfigurar un conjunto que comparta los datos y colaboren unos con los otros, cada uno con su tarea especifica. Como puedo hacerlo?u_atoken=2f1ce793437b13d1a7089116fca091c7
 
  
 
 
 
profile
Qwen3-235B-A22B-2507

¬°Perfecto! Instalar Home Assistant, Node-RED, InfluxDB y Grafana en contenedores Docker dentro de una m√°quina Debian 12 es una excelente forma de crear un sistema de automatizaci√≥n dom√©stica robusto y escalable. A continuaci√≥n, te guiar√© paso a paso para configurar todo usando un archivo docker-compose.yml, lo que facilita el despliegue y la gesti√≥n de los servicios. 
 
‚úÖ Objetivo 

Crear un entorno donde: 

    Home Assistant gestiona dispositivos y automatizaciones.
    Node-RED maneja flujos de automatizaci√≥n avanzados.
    InfluxDB almacena m√©tricas de sensores y dispositivos.
    Grafana visualiza esos datos en paneles.
     

Todos los servicios estar√°n en contenedores Docker, comunic√°ndose entre s√≠ mediante una red Docker compartida y compartiendo vol√∫menes para persistencia. 
 
üîß PASO 1: Instalar Docker y Docker Compose 

En tu m√°quina Debian 12, ejecuta: 
bash
 
 
# Actualizar sistema
sudo apt update && sudo apt upgrade -y

# Instalar dependencias
sudo apt install -y curl git apt-transport-https ca-certificates software-properties-common

# A√±adir repositorio oficial de Docker
curl -fsSL https://get.docker.com | sh

# A√±adir tu usuario al grupo docker (para no usar sudo)
sudo usermod -aG docker $USER

# Instalar Docker Compose (versi√≥n actual)
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
# Actualizar sistema
sudo apt update && sudo apt upgrade -y

# Instalar dependencias
sudo apt install -y curl git apt-transport-https ca-certificates software-properties-common

# A√±adir repositorio oficial de Docker
curl -fsSL https://get.docker.com | sh

# A√±adir tu usuario al grupo docker (para no usar sudo)
sudo usermod -aG docker $USER

# Instalar Docker Compose (versi√≥n actual)
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
 
 

    Cierra y vuelve a abrir la terminal para que el grupo docker tenga efecto. 
     

 
üìÅ PASO 2: Crear la estructura de directorios 
bash
 
mkdir -p ~/homeassistant/{config,data}
mkdir -p ~/nodered/data
mkdir -p ~/influxdb/data
mkdir -p ~/grafana/data
 
 

Esto crea carpetas para persistir la configuraci√≥n y datos. 
 
üìÑ PASO 3: Crear el archivo docker-compose.yml 

Crea un archivo en tu directorio principal: 
bash
 
 
nano ~/docker-compose.yml
 
 

Y pega el siguiente contenido: 
yaml

  version: '3.8'

services:
  homeassistant:
    image: ghcr.io/home-assistant/home-assistant:stable
    container_name: homeassistant
    restart: unless-stopped
    privileged: true
    network_mode: host
    volumes:
      - ~/homeassistant/config:/config
      - /run/dbus:/run/dbus
    environment:
      - TZ=Europe/Madrid  # Cambia a tu zona horaria
    devices:
      - /dev/ttyUSB0:/dev/ttyUSB0  # Si usas Z-Wave/Zigbee
      - /dev/serial/by-id/usb-1a86_7523-if00-port0:/dev/ttyUSB0  # Ajusta seg√∫n tu dispositivo
    depends_on:
      - nodered

  nodered:
    image: nodered/node-red:latest
    container_name: nodered
    restart: unless-stopped
    user: "1000:1000"
    ports:
      - "1880:1880"
    volumes:    - ~/nodered/data:/data
      - /etc/localtime:/etc/localtime:ro
    environment:
      - TZ=Europe/Madrid
    networks:
      - home_net

  influxdb:
    image: influxdb:1.8-alpine
    container_name: influxdb
    restart: unless-stopped
    ports:
      - "8086:8086"
    environment:
      - INFLUXDB_DB=homeassistant
      - INFLUXDB_ADMIN_USER=admin
      - INFLUXDB_ADMIN_PASSWORD=your_strong_password  # Cambia esto
      - INFLUXDB_USER=grafana
      - INFLUXDB_USER_PASSWORD=grafana_password        # Cambia esto
      - INFLUXDB_HTTP_AUTH_ENABLED=true
    volumes:
      - ~/influxdb/data:/var/lib/influxdb
    networks:
      - home_net

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=grafana_admin_pass  # Cambia esto
      - GF_INSTALL_PLUGINS=grafana-piechart-panel
    volumes:
      - ~/grafana/data:/var/lib/grafana
      - /etc/localtime:/etc/localtime:ro
    networks:
      - home_net
    depends_on:
      - influxdb

networks:
  home_net:
    driver: bridge
 

    ‚ö†Ô∏è Importante: 

        Cambia las contrase√±as (your_strong_password, grafana_password, grafana_admin_pass).
        Ajusta la zona horaria (TZ) a la tuya (ej: America/New_York, Asia/Tokyo, etc).
        Si usas dispositivos Zigbee/Z-Wave, ajusta la ruta del dispositivo serial (/dev/ttyUSB0, etc).
         

     

 
‚ñ∂Ô∏è PASO 4: Iniciar los servicios 
bash
 
cd ~
docker-compose up -d
 
 

Esto descargar√° las im√°genes y arrancar√° los contenedores. 
 
üîç PASO 5: Acceder a las interfaces 

Una vez iniciados: 
Home Assistant
	
http://tu_ip:8123
	
Primera vez: crear usuario
Node-RED
	
http://tu_ip:1880
	
Sin autenticaci√≥n (puedes activarla despu√©s)
Grafana
	
http://tu_ip:3000
	
Usuario:
admin
, Contrase√±a:
grafana_admin_pass
InfluxDB
	
http://tu_ip:8086
(API/CLI)
	
No tiene interfaz web en v1.8
 
 
 
üîÑ PASO 6: Configurar integraci√≥n entre servicios 
1. Home Assistant ‚Üí InfluxDB 

Edita ~/homeassistant/config/configuration.yaml y a√±ade: 
yaml
 
 
recorder:
  db_url: mysql://admin:your_strong_password@localhost:8086/homeassistant?ssl=false
  # Nota: en realidad, Home Assistant no guarda directamente en InfluxDB por recorder.
  # Mejor usar el siguiente m√©todo:

  # Desactivamos recorder para InfluxDB porque usamos el add-on de exportaci√≥n.
 
 

Mejor usar Node-RED o la integraci√≥n nativa de InfluxDB. 
Opci√≥n recomendada: Usa el componente de InfluxDB en Home Assistant 

Agrega en configuration.yaml: 
yaml
 
 
influxdb:
  host: influxdb
  port: 8086
  database: homeassistant
  username: admin
  password: your_strong_password
  max_retries: 3
 
 

    Esto har√° que Home Assistant env√≠e autom√°ticamente estados a InfluxDB. 
     

 
2. Grafana ‚Üí InfluxDB (Fuente de datos) 

    Accede a Grafana (http://tu_ip:3000).
    Ve a Configuration ‚Üí Data Sources ‚Üí Add data source.
    Selecciona InfluxDB.
    Configura:
        URL: http://influxdb:8086
        Database: homeassistant
        User: grafana
        Password: grafana_password
        HTTP Method: GET
         
    Haz clic en Save & Test.
     

 
3. Node-RED ‚Üí Home Assistant 

    Usa el paquete node-red-contrib-home-assistant-websocket.
    En Node-RED, inst√°lalo desde el administrador de paquetes.
    Con√©ctate a Home Assistant usando el token de acceso (crea uno en http://tu_ip:8123/profile ‚Üí "Long-Lived Access Token").
     

 
4. Node-RED ‚Üí InfluxDB 

    Usa el nodo influxdb out.
    Configura la conexi√≥n con:
        Host: influxdb
        Port: 8086
        Database: homeassistant
        Auth: usuario grafana y contrase√±a.
         
     

 
üõ°Ô∏è PASO 7: Seguridad adicional (recomendado) 

    Inverso Proxy (opcional): Usa Nginx Proxy Manager o Traefik para exponer servicios con HTTPS.
    Backups: Haz copias de ~/homeassistant/config, ~/influxdb/data, ~/grafana/data.
    Firewall: Usa ufw para bloquear puertos no necesarios.
     

bash
 
 
sudo ufw allow 22
sudo ufw allow 8123    # Home Assistant
sudo ufw allow 1880    # Node-RED
sudo ufw allow 3000    # Grafana
sudo ufw enable
 
 
 
üîÑ Actualizaciones 
bash
 
# Detener y actualizar
docker-compose down
docker-compose pull
docker-compose up -d
 
 
 
‚úÖ Resumen 
Home Assistant
	
Automatizaci√≥n central
Node-RED
	
Flujos avanzados y l√≥gica
InfluxDB
	
Almacenamiento de series temporales
Grafana
	
Visualizaci√≥n de m√©tricas
 
 

Todo en Docker, aislado, persistente y comunic√°ndose en una red interna. 
 

¬øQuieres que te genere un script autom√°tico de instalaci√≥n o una versi√≥n con HTTPS y dominio? Puedo ayudarte tambi√©n con eso. 
 
 

si, generame un scrip automatico de instalacion
 
  
 
 
 
 
profile
Qwen3-235B-A22B-2507 10:29 pm

¬°Claro! Aqu√≠ tienes un script autom√°tico de instalaci√≥n que har√° todo por ti: instalar√° Docker, Docker Compose, crear√° la estructura de directorios, configurar√° el docker-compose.yml y arrancar√° todos los servicios (Home Assistant, Node-RED, InfluxDB y Grafana). 

    ‚úÖ Solo necesitas ejecutar este script en tu m√°quina Debian 12 y responder algunas preguntas b√°sicas (contrase√±as, zona horaria, etc.). 
     

 
üìú Script de Instalaci√≥n Autom√°tica 

Guarda este script como install_ha_stack.sh: 
bash
 
 

#!/bin/bash
    networks:
      - home_net

  influxdb:
    image: influxdb:1.8-alpine
    container_name: influxdb
    restart: unless-stopped
    ports:
      - "8086:8086"
    environment:
      - INFLUXDB_DB=homeassistant
      - INFLUXDB_ADMIN_USER=admin
      - INFLUXDB_ADMIN_PASSWORD=${INFLUXDB_ADMIN_PASS}
      - INFLUXDB_USER=grafana
      - INFLUXDB_USER_PASSWORD=${INFLUXDB_USER_PASS}
      - INFLUXDB_HTTP_AUTH_ENABLED=true
    volumes:
      - ~/influxdb/data:/var/lib/influxdb
    networks:
      - home_net

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASS}
      - GF_INSTALL_PLUGINS=grafana-piechart-panel
    volumes:
      - ~/grafana/data:/var/lib/grafana
      - /etc/localtime:/etc/localtime:ro
    networks:
      - home_net
    depends_on:
      - influxdb

networks:
  home_net:
    driver: bridge
EOF

# -----------------------------------------------
# 8. Iniciar servicios
# -----------------------------------------------
echo -e "${GREEN}üöÄ Iniciando contenedores...${NC}"
cd $HOME
docker-compose up -d

# -----------------------------------------------
# 9. Mostrar resumen
# -----------------------------------------------
IP=$(hostname -I | awk '{print $1}')

echo -e "\n${GREEN}üéâ Instalaci√≥n completada con √©xito!${NC}"
echo -e "\n${YELLOW}Accede a los servicios:${NC}"
echo -e "   üîπ Home Assistant: http://${IP}:8123"
echo -e "   üîπ Node-RED:       http://${IP}:1880"
echo -e "   üîπ Grafana:        http://${IP}:3000  (usuario: admin)"
echo -e "   üîπ InfluxDB API:   http://${IP}:8086"
echo -e "\n${YELLOW}Pr√≥ximos pasos:${NC}"
echo -e "   1. Abre Home Assistant y configura tu cuenta."
echo -e "   2. En Grafana, inicia sesi√≥n y a√±ade InfluxDB como fuente de datos:"
echo -e "      - URL: http://influxdb:8086"
echo -e "      - Base de datos: homeassistant"
echo -e "      - Usuario: grafana / Contrase√±a: la que ingresaste"
echo -e "   3. En Home Assistant, edita ~/homeassistant/config/configuration.yaml"
echo -e "      para incluir el componente InfluxDB si deseas enviar estados autom√°ticamente."

if [ -n "$ZIGBEE_DEVICE" ]; then
  echo -e "\n${GREEN}üîå Dispositivo Zigbee/Z-Wave detectado: ${ZIGBEE_DEVICE}${NC}"
fi

echo -e "\n${YELLOW}üí° Nota: Reinicia la terminal para que los cambios de grupo 'docker' surtan efecto.${NC}"
echo -e "${YELLOW}    O ejecuta: newgrp docker${NC}"
 
 
 
‚ñ∂Ô∏è C√≥mo usar el script 

    Guarda el script en tu m√°quina Debian 12:
     

bash
 
 
1
nano install_ha_stack.sh
 
 

Pega el contenido, luego guarda con Ctrl+O, Enter, Ctrl+X. 

    Dale permisos de ejecuci√≥n:
     

bash
 
 
1
chmod +x install_ha_stack.sh
 
 

    Ejec√∫talo:
     

bash
 
 
1
./install_ha_stack.sh
 
 

    ‚ö†Ô∏è El script te pedir√° contrase√±as y datos. Aseg√∫rate de anotarlas. 
     

 
üîÑ Actualizaci√≥n futura 

Para actualizar los servicios m√°s adelante: 
bash
 
 
1
2
3
4
cd ~
docker-compose down
docker-compose pull
docker-compose up -d
 
 
 
üîê Recomendaciones de seguridad (opcional pero recomendado) 

    Usa un proxy inverso (como Nginx Proxy Manager o Caddy) con HTTPS.
    Cambia los puertos expuestos si expones al exterior.
    Habilita autenticaci√≥n en Node-RED (settings.js).
    Haz copias de seguridad regulares de las carpetas:
        ~/homeassistant/config
        ~/grafana/data
        ~/influxdb/data
         
     

 

¬øQuieres que te genere tambi√©n una versi√≥n con HTTPS autom√°tico usando Traefik o Nginx Proxy Manager? Puedo ayudarte a montar un entorno profesional listo para producci√≥n. 
